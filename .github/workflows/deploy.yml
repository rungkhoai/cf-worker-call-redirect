name: Deploy Worker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy with Wrangler v4
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: deploy

      - name: Ensure DNS record exists for call.rungkhoai.com
        run: |
          ZONE_ID=${{ secrets.CF_ZONE_ID }}
          API="https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records"
          AUTH="Authorization: Bearer ${{ secrets.CF_API_TOKEN_DNS }}"

          # 1. Kiá»ƒm tra DNS Ä‘Ã£ tá»“n táº¡i chÆ°a
          RECORD_ID=$(curl -s -X GET "$API?type=CNAME&name=call.rungkhoai.com" \
            -H "$AUTH" -H "Content-Type: application/json" \
            | jq -r '.result[0].id')

          if [ "$RECORD_ID" != "null" ] && [ -n "$RECORD_ID" ]; then
            echo "ðŸ”„ DNS record tá»“n táº¡i, cáº­p nháº­t..."
            curl -s -X PUT "$API/$RECORD_ID" \
              -H "$AUTH" -H "Content-Type: application/json" \
              --data '{
                "type":"CNAME",
                "name":"call",
                "content":"rungkhoai.com",
                "ttl":1,
                "proxied":true
              }'
          else
            echo "âž• DNS record chÆ°a cÃ³, táº¡o má»›i..."
            curl -s -X POST "$API" \
              -H "$AUTH" -H "Content-Type: application/json" \
              --data '{
                "type":"CNAME",
                "name":"call",
                "content":"rungkhoai.com",
                "ttl":1,
                "proxied":true
              }'
          fi
